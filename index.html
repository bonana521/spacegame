<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D星际探索游戏</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            color: #00ff00;
        }
        
        #gameCanvas {
            display: block;
            cursor: none;
        }
        
        /* 驾驶舱UI容器 */
        .cockpit-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 150;
        }
        
        /* 状态指示器 */
        .status-lights {
            position: absolute;
            top: 30px;
            left: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .status-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #666;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .status-light.active {
            background: #00ff00;
            box-shadow: 0 0 15px #00ff00;
        }
        
        .status-light.warning {
            background: #ffff00;
            box-shadow: 0 0 15px #ffff00;
        }
        
        .status-light.danger {
            background: #ff0000;
            box-shadow: 0 0 15px #ff0000;
        }
        
        /* 速度表 */
        .speed-indicator {
            position: absolute;
            bottom: 120px;
            left: 80px;
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, rgba(0,255,0,0.1) 0%, rgba(0,255,0,0.3) 100%);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
        }
        
        .speed-label {
            font-size: 12px;
            color: #00ff00;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .speed-value {
            font-size: 28px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .speed-unit {
            font-size: 14px;
            color: #00ff00;
            margin-left: 5px;
        }
        
        /* 雷达 */
        .radar-screen {
            position: absolute;
            top: 80px;
            right: 80px;
            width: 180px;
            height: 180px;
            border: 3px solid #00ff00;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,255,0,0.05) 0%, rgba(0,255,0,0.2) 100%);
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        
        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 90px;
            background: linear-gradient(to bottom, #00ff00, transparent);
            transform-origin: bottom center;
            animation: radar-sweep 4s linear infinite;
        }
        
        @keyframes radar-sweep {
            0% { transform: translate(-50%, -100%) rotate(0deg); }
            100% { transform: translate(-50%, -100%) rotate(360deg); }
        }
        
        /* 燃料表 */
        .fuel-indicator {
            position: absolute;
            bottom: 120px;
            right: 80px;
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, rgba(0,255,0,0.1) 0%, rgba(0,255,0,0.3) 100%);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
        }
        
        .fuel-bar {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #00ff00;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .fuel-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00aa00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }
        
        /* 控制面板 */
        .control-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 15px;
            border: 2px solid #333;
            pointer-events: auto;
        }
        
        .cockpit-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        
        .cockpit-button:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .cockpit-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* HUD显示 */
        .hud-display {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .hud-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .hud-coordinates {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* 瞄准镜 */
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid #00ff00;
            border-radius: 50%;
            z-index: 200;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        
        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: #00ff00;
            box-shadow: 0 0 10px rgba(0,255,0,0.8);
        }
        
        #crosshair::before {
            top: 50%;
            left: -10px;
            right: -10px;
            height: 2px;
            transform: translateY(-50%);
        }
        
        #crosshair::after {
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 2px;
            transform: translateX(-50%);
        }
        
        /* 瞄准圈 */
        .aiming-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 1px solid rgba(0,255,0,0.3);
            border-radius: 50%;
            z-index: 199;
            pointer-events: none;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.1; transform: translate(-50%, -50%) scale(1.1); }
        }
        
        /* 加载界面 */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 300;
            text-align: center;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        
        .loading-spinner {
            border: 4px solid #333;
            border-top: 4px solid #00ff00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 警告信息 */
        .warning-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 250;
            display: none;
            box-shadow: 0 0 30px rgba(255,0,0,0.5);
        }
        
        /* 传感器信息 */
        .sensor-info {
            position: absolute;
            top: 200px;
            right: 80px;
            width: 180px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .sensor-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .sensor-label {
            color: #00ff00;
            opacity: 0.8;
        }
        
        .sensor-value {
            color: #00ff00;
            font-weight: bold;
        }
        
        /* 鼠标锁定提示 */
        .mouse-lock-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            z-index: 400;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
            transition: opacity 0.3s ease;
        }
        
        .mouse-lock-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* 鼠标锁定状态指示器 */
        .lock-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            border: 2px solid #666;
            transition: all 0.3s ease;
        }
        
        .lock-indicator.locked {
            background: #00ff00;
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
        <p>正在加载驾驶舱系统...</p>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <!-- 驾驶舱UI界面 -->
    <div class="cockpit-ui">
        <!-- HUD显示 -->
        <div class="hud-display">
            <div class="hud-title">STARSHIP COCKPIT</div>
            <div class="hud-coordinates" id="coordinates">X: 0.0 Y: 0.0 Z: 0.0</div>
        </div>
        
        <!-- 状态指示器 -->
        <div class="status-lights">
            <div class="status-light active" id="system-light" title="系统状态"></div>
            <div class="status-light active" id="engine-light" title="引擎状态"></div>
            <div class="status-light active" id="shield-light" title="护盾状态"></div>
            <div class="status-light" id="weapon-light" title="武器状态"></div>
        </div>
        
        <!-- 速度表 -->
        <div class="speed-indicator">
            <div class="speed-label">速度</div>
            <div>
                <span class="speed-value" id="speed-value">0.0</span>
                <span class="speed-unit">KM/S</span>
            </div>
        </div>
        
        <!-- 雷达 -->
        <div class="radar-screen">
            <div class="radar-sweep"></div>
        </div>
        
        <!-- 燃料表 -->
        <div class="fuel-indicator">
            <div class="speed-label">燃料</div>
            <div class="fuel-bar">
                <div class="fuel-fill" id="fuel-fill"></div>
            </div>
            <div style="text-align: center; margin-top: 5px;">
                <span id="fuel-percent">100</span>%
            </div>
        </div>
        
        <!-- 传感器信息 -->
        <div class="sensor-info">
            <div class="sensor-item">
                <span class="sensor-label">已探索:</span>
                <span class="sensor-value" id="explored-count">0</span>
            </div>
            <div class="sensor-item">
                <span class="sensor-label">目标距离:</span>
                <span class="sensor-value" id="target-distance">--</span>
            </div>
            <div class="sensor-item">
                <span class="sensor-label">曲速状态:</span>
                <span class="sensor-value" id="warp-status">OFF</span>
            </div>
        </div>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <button class="cockpit-button" onclick="toggleWarp()">曲速引擎</button>
            <button class="cockpit-button" onclick="findNearestPlanet()">导航</button>
            <button class="cockpit-button" onclick="toggleShield()">护盾</button>
        </div>
        
        <!-- 瞄准系统 -->
        <div class="aiming-circle"></div>
        <div id="crosshair"></div>
        
        <!-- 警告信息 -->
        <div class="warning-message" id="warning-message"></div>
        
        <!-- 鼠标锁定提示 -->
        <div class="mouse-lock-hint" id="mouse-lock-hint">
            点击屏幕锁定鼠标以控制视角<br>
            <small>按 ESC 键退出锁定</small>
        </div>
        
        <!-- 鼠标锁定状态指示器 -->
        <div class="lock-indicator" id="lock-indicator" title="鼠标锁定状态"></div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 游戏状态
        const gameState = {
            camera: null,
            scene: null,
            renderer: null,
            spaceship: null,
            cockpit: null,
            planets: [],
            stars: null,
            fuel: 100,
            speed: 0,
            maxSpeed: 10,
            exploredSystems: 0,
            isWarpActive: false,
            shieldActive: false,
            targetPlanet: null,
            keys: {},
            mouse: { x: 0, y: 0 },
            cameraRotation: { x: 0, y: 0 },
            targetRotation: { x: 0, y: 0 },
            clock: new THREE.Clock()
        };
        
        // 初始化游戏
        function init() {
            // 创建场景
            gameState.scene = new THREE.Scene();
            
            // 创建相机
            gameState.camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                10000
            );
            gameState.camera.position.set(0, 2, 5);
            
            // 创建渲染器
            gameState.renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('gameCanvas'),
                antialias: true 
            });
            gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            gameState.renderer.setClearColor(0x000011);
            gameState.renderer.shadowMap.enabled = true;
            gameState.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // 创建星空背景
            createStarField();
            
            // 创建飞船
            createSpaceship();
            
            // 创建驾驶舱
            createCockpit();
            
            // 创建行星系统
            createPlanetSystem();
            
            // 创建光照
            createLighting();
            
            // 设置事件监听
            setupEventListeners();
            
            // 开始游戏循环
            animate();
            
            // 隐藏加载界面
            document.getElementById('loading').style.display = 'none';
            
            // 初始化鼠标锁定状态
            updateMouseLockStatus();
        }
        
        // 创建星空背景
        function createStarField() {
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({
                color: 0xFFFFFF,
                size: 0.5,
                transparent: true,
                opacity: 0.8
            });
            
            const starVertices = [];
            for (let i = 0; i < 50000; i++) {
                const x = (Math.random() - 0.5) * 5000;
                const y = (Math.random() - 0.5) * 5000;
                const z = (Math.random() - 0.5) * 5000;
                starVertices.push(x, y, z);
            }
            
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            gameState.stars = new THREE.Points(starGeometry, starMaterial);
            gameState.scene.add(gameState.stars);
        }
        
        // 创建飞船
        function createSpaceship() {
            const shipGroup = new THREE.Group();
            
            // 飞船主体（外部）
            const bodyGeometry = new THREE.ConeGeometry(2, 8, 8);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x4488FF,
                shininess: 100,
                transparent: true,
                opacity: 0.3
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.x = Math.PI / 2;
            shipGroup.add(body);
            
            // 飞船引擎
            const engineGeometry = new THREE.CylinderGeometry(0.6, 1, 2, 8);
            const engineMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFF4444,
                emissive: 0x440000 
            });
            const engine = new THREE.Mesh(engineGeometry, engineMaterial);
            engine.position.z = -4;
            engine.rotation.x = Math.PI / 2;
            shipGroup.add(engine);
            
            // 飞船翼
            const wingGeometry = new THREE.BoxGeometry(6, 0.2, 2);
            const wingMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x666666,
                transparent: true,
                opacity: 0.3
            });
            const wing = new THREE.Mesh(wingGeometry, wingMaterial);
            wing.position.z = -2;
            shipGroup.add(wing);
            
            gameState.spaceship = shipGroup;
            gameState.scene.add(gameState.spaceship);
        }
        
        // 创建驾驶舱
        function createCockpit() {
            const cockpitGroup = new THREE.Group();
            
            // 驾驶舱框架
            const frameGeometry = new THREE.BoxGeometry(4, 3, 6);
            const frameMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x333333,
                transparent: true,
                opacity: 0.6
            });
            const frame = new THREE.Mesh(frameGeometry, frameMaterial);
            cockpitGroup.add(frame);
            
            // 前挡风玻璃
            const glassGeometry = new THREE.PlaneGeometry(3.5, 2.5);
            const glassMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x88CCFF,
                transparent: true,
                opacity: 0.1,
                reflectivity: 0.9,
                side: THREE.DoubleSide
            });
            const windshield = new THREE.Mesh(glassGeometry, glassMaterial);
            windshield.position.z = -2.9;
            cockpitGroup.add(windshield);
            
            // 侧边玻璃
            const sideGlassGeometry = new THREE.PlaneGeometry(2.5, 2.5);
            const leftGlass = new THREE.Mesh(sideGlassGeometry, glassMaterial);
            leftGlass.position.set(-1.75, 0, -1);
            leftGlass.rotation.y = Math.PI / 2;
            cockpitGroup.add(leftGlass);
            
            const rightGlass = new THREE.Mesh(sideGlassGeometry, glassMaterial);
            rightGlass.position.set(1.75, 0, -1);
            rightGlass.rotation.y = -Math.PI / 2;
            cockpitGroup.add(rightGlass);
            
            // 控制面板
            const panelGeometry = new THREE.BoxGeometry(3, 0.3, 1);
            const panelMaterial = new THREE.MeshPhongMaterial({ color: 0x222222 });
            const panel = new THREE.Mesh(panelGeometry, panelMaterial);
            panel.position.set(0, -1, -1);
            cockpitGroup.add(panel);
            
            // 仪表盘
            const dashboardGeometry = new THREE.BoxGeometry(3.2, 0.1, 0.5);
            const dashboardMaterial = new THREE.MeshPhongMaterial({ color: 0x111111 });
            const dashboard = new THREE.Mesh(dashboardGeometry, dashboardMaterial);
            dashboard.position.set(0, 0.5, -2.8);
            cockpitGroup.add(dashboard);
            
            // 座椅
            const seatGeometry = new THREE.BoxGeometry(1.5, 0.5, 1.5);
            const seatMaterial = new THREE.MeshPhongMaterial({ color: 0x444444 });
            const seat = new THREE.Mesh(seatGeometry, seatMaterial);
            seat.position.set(0, -0.75, 0.5);
            cockpitGroup.add(seat);
            
            // 座椅靠背
            const backrestGeometry = new THREE.BoxGeometry(1.5, 1.5, 0.3);
            const backrest = new THREE.Mesh(backrestGeometry, seatMaterial);
            backrest.position.set(0, 0, 1.2);
            cockpitGroup.add(backrest);
            
            // 控制杆
            const stickGeometry = new THREE.CylinderGeometry(0.1, 0.15, 0.8);
            const stickMaterial = new THREE.MeshPhongMaterial({ color: 0x666666 });
            const stick = new THREE.Mesh(stickGeometry, stickMaterial);
            stick.position.set(0, -0.4, 0.5);
            cockpitGroup.add(stick);
            
            // 控制杆手柄
            const handleGeometry = new THREE.SphereGeometry(0.15, 8, 8);
            const handle = new THREE.Mesh(handleGeometry, stickMaterial);
            handle.position.set(0, 0, 0.5);
            cockpitGroup.add(handle);
            
            gameState.cockpit = cockpitGroup;
            gameState.scene.add(gameState.cockpit);
        }
        
        // 创建行星系统
        function createPlanetSystem() {
            const planetData = [
                { name: '地球', color: 0x4488FF, size: 3, distance: 50, speed: 0.01 },
                { name: '火星', color: 0xFF4444, size: 2, distance: 80, speed: 0.008 },
                { name: '木星', color: 0xFFAA44, size: 8, distance: 150, speed: 0.005 },
                { name: '土星', color: 0xFFDD44, size: 6, distance: 200, speed: 0.003 },
                { name: '海王星', color: 0x4444FF, size: 5, distance: 280, speed: 0.002 }
            ];
            
            planetData.forEach((data, index) => {
                const planetGroup = new THREE.Group();
                
                // 创建行星
                const planetGeometry = new THREE.SphereGeometry(data.size, 32, 32);
                const planetMaterial = new THREE.MeshPhongMaterial({ 
                    color: data.color,
                    shininess: 30
                });
                const planet = new THREE.Mesh(planetGeometry, planetMaterial);
                planet.castShadow = true;
                planet.receiveShadow = true;
                planetGroup.add(planet);
                
                // 创建轨道
                const orbitGeometry = new THREE.RingGeometry(data.distance - 0.5, data.distance + 0.5, 64);
                const orbitMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x444444, 
                    transparent: true, 
                    opacity: 0.3,
                    side: THREE.DoubleSide
                });
                const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
                orbit.rotation.x = Math.PI / 2;
                gameState.scene.add(orbit);
                
                // 设置初始位置
                planetGroup.position.x = data.distance;
                
                // 添加到场景
                gameState.scene.add(planetGroup);
                
                // 保存行星数据
                gameState.planets.push({
                    group: planetGroup,
                    data: data,
                    angle: Math.random() * Math.PI * 2,
                    explored: false
                });
            });
        }
        
        // 创建光照
        function createLighting() {
            // 太阳光
            const sunLight = new THREE.PointLight(0xFFFFFF, 2, 500);
            sunLight.position.set(0, 0, 0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            gameState.scene.add(sunLight);
            
            // 环境光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            gameState.scene.add(ambientLight);
            
            // 太阳
            const sunGeometry = new THREE.SphereGeometry(5, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xFFFF00,
                emissive: 0xFFFF00
            });
            const sun = new THREE.Mesh(sunGeometry, sunMaterial);
            gameState.scene.add(sun);
        }
        
        // 设置事件监听
        function setupEventListeners() {
            // 键盘事件
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.key.toLowerCase()] = true;
            });
            
            document.addEventListener('keyup', (e) => {
                gameState.keys[e.key.toLowerCase()] = false;
            });
            
            // 鼠标事件 - 驾驶舱视角控制
            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === document.body) {
                    const deltaX = e.movementX || 0;
                    const deltaY = e.movementY || 0;
                    
                    // 更新目标旋转角度
                    gameState.targetRotation.y -= deltaX * 0.002;
                    gameState.targetRotation.x -= deltaY * 0.002;
                    
                    // 限制垂直旋转角度
                    gameState.targetRotation.x = Math.max(-Math.PI/3, Math.min(Math.PI/3, gameState.targetRotation.x));
                }
            });
            
            // 锁定鼠标指针到屏幕中心
            document.addEventListener('click', () => {
                if (document.pointerLockElement !== document.body) {
                    document.body.requestPointerLock();
                }
            });
            
            // 鼠标锁定状态变化
            document.addEventListener('pointerlockchange', () => {
                updateMouseLockStatus();
            });
            
            // 窗口大小改变
            window.addEventListener('resize', () => {
                gameState.camera.aspect = window.innerWidth / window.innerHeight;
                gameState.camera.updateProjectionMatrix();
                gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        // 更新鼠标锁定状态
        function updateMouseLockStatus() {
            const isLocked = document.pointerLockElement === document.body;
            const hint = document.getElementById('mouse-lock-hint');
            const indicator = document.getElementById('lock-indicator');
            
            if (isLocked) {
                hint.classList.add('hidden');
                indicator.classList.add('locked');
            } else {
                hint.classList.remove('hidden');
                indicator.classList.remove('locked');
            }
        }
        
        // 更新飞船控制
        function updateSpaceship() {
            const deltaTime = gameState.clock.getDelta();
            
            // 平滑过渡相机旋转
            gameState.cameraRotation.x += (gameState.targetRotation.x - gameState.cameraRotation.x) * 0.1;
            gameState.cameraRotation.y += (gameState.targetRotation.y - gameState.cameraRotation.y) * 0.1;
            
            // 计算飞行方向（基于相机朝向）
            const forward = new THREE.Vector3(0, 0, -1);
            const right = new THREE.Vector3(1, 0, 0);
            const up = new THREE.Vector3(0, 1, 0);
            
            // 应用相机旋转到方向向量
            forward.applyQuaternion(
                new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(gameState.cameraRotation.x, gameState.cameraRotation.y, 0)
                )
            );
            right.applyQuaternion(
                new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(0, gameState.cameraRotation.y, 0)
                )
            );
            
            // 键盘控制（相对于相机朝向）
            if (gameState.keys['w']) {
                gameState.spaceship.position.add(forward.clone().multiplyScalar(0.5));
                gameState.speed = Math.min(gameState.speed + 0.1, gameState.maxSpeed);
            }
            if (gameState.keys['s']) {
                gameState.spaceship.position.add(forward.clone().multiplyScalar(-0.5));
                gameState.speed = Math.max(gameState.speed - 0.1, 0);
            }
            if (gameState.keys['a']) {
                gameState.spaceship.position.add(right.clone().multiplyScalar(-0.5));
            }
            if (gameState.keys['d']) {
                gameState.spaceship.position.add(right.clone().multiplyScalar(0.5));
            }
            if (gameState.keys['q']) {
                gameState.spaceship.position.add(up.clone().multiplyScalar(0.5));
            }
            if (gameState.keys['e']) {
                gameState.spaceship.position.add(up.clone().multiplyScalar(-0.5));
            }
            
            // 空格加速
            if (gameState.keys[' ']) {
                gameState.speed = Math.min(gameState.speed + 0.2, gameState.maxSpeed * 2);
                gameState.fuel = Math.max(gameState.fuel - 0.1, 0);
            }
            
            // Shift减速
            if (gameState.keys['shift']) {
                gameState.speed = Math.max(gameState.speed - 0.2, 0);
            }
            
            // 更新相机位置和朝向
            updateCamera();
            
            // 自动减速
            if (!gameState.keys['w'] && !gameState.keys['s'] && !gameState.keys[' ']) {
                gameState.speed *= 0.99;
            }
            
            // 更新行星
            gameState.planets.forEach(planet => {
                planet.angle += planet.data.speed;
                planet.group.position.x = Math.cos(planet.angle) * planet.data.distance;
                planet.group.position.z = Math.sin(planet.angle) * planet.data.distance;
                
                // 检查是否接近行星
                const distance = gameState.spaceship.position.distanceTo(planet.group.position);
                if (distance < planet.data.size + 10 && !planet.explored) {
                    planet.explored = true;
                    gameState.exploredSystems++;
                }
            });
            
            // 更新UI
            updateUI();
        }
        
        // 更新相机和驾驶舱
        function updateCamera() {
            // 计算相机偏移
            const cameraOffset = new THREE.Vector3(0, 2, 0);
            const lookOffset = new THREE.Vector3(0, 2, -10);
            
            // 应用旋转到偏移量
            cameraOffset.applyQuaternion(
                new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(gameState.cameraRotation.x, gameState.cameraRotation.y, 0)
                )
            );
            lookOffset.applyQuaternion(
                new THREE.Quaternion().setFromEuler(
                    new THREE.Euler(gameState.cameraRotation.x, gameState.cameraRotation.y, 0)
                )
            );
            
            // 设置相机位置
            gameState.camera.position.copy(gameState.spaceship.position).add(cameraOffset);
            
            // 设置相机朝向
            const lookAtPoint = gameState.spaceship.position.clone().add(lookOffset);
            gameState.camera.lookAt(lookAtPoint);
            
            // 更新驾驶舱旋转
            if (gameState.cockpit) {
                gameState.cockpit.position.copy(gameState.spaceship.position);
                gameState.cockpit.rotation.x = gameState.cameraRotation.x;
                gameState.cockpit.rotation.y = gameState.cameraRotation.y;
            }
        }
        
        // 更新UI
        function updateUI() {
            // 更新坐标显示
            document.getElementById('coordinates').textContent = 
                `X: ${gameState.spaceship.position.x.toFixed(1)} Y: ${gameState.spaceship.position.y.toFixed(1)} Z: ${gameState.spaceship.position.z.toFixed(1)}`;
            
            // 更新速度显示
            document.getElementById('speed-value').textContent = gameState.speed.toFixed(1);
            
            // 更新燃料显示
            document.getElementById('fuel-percent').textContent = gameState.fuel.toFixed(0);
            document.getElementById('fuel-fill').style.width = gameState.fuel + '%';
            
            // 更新探索数量
            document.getElementById('explored-count').textContent = gameState.exploredSystems;
            
            // 更新曲速状态
            document.getElementById('warp-status').textContent = gameState.isWarpActive ? 'ON' : 'OFF';
            document.getElementById('warp-status').style.color = gameState.isWarpActive ? '#00ff00' : '#ff0000';
            
            // 计算到最近行星的距离
            let minDistance = Infinity;
            gameState.planets.forEach(planet => {
                const distance = gameState.spaceship.position.distanceTo(planet.group.position);
                minDistance = Math.min(minDistance, distance);
            });
            
            if (minDistance < Infinity) {
                document.getElementById('target-distance').textContent = (minDistance / 10).toFixed(1) + ' AU';
            }
            
            // 更新状态指示灯
            updateStatusLights();
            
            // 更新燃料警告
            if (gameState.fuel < 20) {
                document.getElementById('fuel-fill').style.background = 'linear-gradient(90deg, #ff0000, #aa0000)';
                showWarning('燃料不足！');
            } else if (gameState.fuel < 50) {
                document.getElementById('fuel-fill').style.background = 'linear-gradient(90deg, #ffff00, #aaaa00)';
            } else {
                document.getElementById('fuel-fill').style.background = 'linear-gradient(90deg, #00ff00, #00aa00)';
            }
        }
        
        // 更新状态指示灯
        function updateStatusLights() {
            // 系统状态
            const systemLight = document.getElementById('system-light');
            systemLight.className = 'status-light active';
            
            // 引擎状态
            const engineLight = document.getElementById('engine-light');
            if (gameState.speed > 0) {
                engineLight.className = 'status-light active';
            } else {
                engineLight.className = 'status-light warning';
            }
            
            // 护盾状态
            const shieldLight = document.getElementById('shield-light');
            if (gameState.shieldActive) {
                shieldLight.className = 'status-light active';
            } else {
                shieldLight.className = 'status-light';
            }
        }
        
        // 显示警告信息
        function showWarning(message) {
            const warningEl = document.getElementById('warning-message');
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            setTimeout(() => {
                warningEl.style.display = 'none';
            }, 3000);
        }
        
        // 游戏循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 更新游戏逻辑
            updateSpaceship();
            
            // 旋转星空
            if (gameState.stars) {
                gameState.stars.rotation.y += 0.0001;
            }
            
            // 渲染场景
            gameState.renderer.render(gameState.scene, gameState.camera);
        }
        
        // 切换曲速引擎
        function toggleWarp() {
            gameState.isWarpActive = !gameState.isWarpActive;
            if (gameState.isWarpActive) {
                gameState.maxSpeed = 50;
                showWarning('曲速引擎已激活！');
            } else {
                gameState.maxSpeed = 10;
                showWarning('曲速引擎已关闭！');
            }
        }
        
        // 切换护盾
        function toggleShield() {
            gameState.shieldActive = !gameState.shieldActive;
            if (gameState.shieldActive) {
                showWarning('护盾已激活！');
            } else {
                showWarning('护盾已关闭！');
            }
        }
        
        // 寻找最近行星
        function findNearestPlanet() {
            let nearestPlanet = null;
            let minDistance = Infinity;
            
            gameState.planets.forEach(planet => {
                const distance = gameState.spaceship.position.distanceTo(planet.group.position);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPlanet = planet;
                }
            });
            
            if (nearestPlanet) {
                gameState.targetPlanet = nearestPlanet;
                showWarning(`目标锁定: ${nearestPlanet.data.name}`);
            }
        }
        
        // 启动游戏
        window.addEventListener('load', init);
    </script>
</body>
</html>